PROJECT: Junk-Punk Titan | Roblox Luau | Rojo-managed
REPO: c:\Users\neila\OneDrive\Desktop\job-exams\junk-punk-titan
COMPLETION: Phases 1-5 DONE + Refinement Phases 1-9 DONE + Visual Polish Phases 1-5 DONE + Visual Manifest Refactor DONE
GDD_PATH: Junk-Punk Titan_ Complete Game Design Document.pdf (in Cursor workspace storage)
QA_PATH: Junk-Punk Titan_ Comprehensive QA Test Plan.pdf (in Cursor workspace storage)
STRATEGY: STRATEGY.md (root) — master task tracker, changelogs per phase

=== FILE MAP ===
src/shared/Constants.luau — all tuning values. Sections: BASE_COSTS, ROLE_DEFINITIONS, THEFT_SETTINGS, BUILDING (sizes/range/cost dynamics, no visual colors), SCALING, MAINTENANCE, WAVES, COMBAT, ECONOMY, STORM, SCRAP_SPAWNS, TITAN
src/shared/VisualManifest.luau — centralized visual source of truth for world/entity/VFX/tool visuals + runtime lighting/atmosphere/post-processing values; current preset is bright industrial day
src/shared/Types.luau — Luau types: RoleName, BuildingType, RoleDefinition, TheftData, LegacyBuff, PurchaseResponse, BlueprintData (incl. rotation), ResourceType, SessionStats
src/shared/Remotes.luau — remote registry. Server creates, client waits. Names map at top. Remotes.Get() returns typed table. Includes SwarmEnded, BuildProgress, CancelBlueprint, PunchEnemy.
src/shared/TheftComponent.luau — reusable dismantle progress tracker. Attach(part), StartDismantle(part, rat, progressMultiplier?), ConnectCompleted(cb)
src/shared/Utils.luau — SnapToGrid(pos,gridSize), RemoveToolByName(player,name)
src/shared/AudioManifest.luau — centralized sound asset IDs. Keys: ShotgunFire, EnemyDeath, BuildPlace, BuildDestroy, RepairHiss, RepairClank, StormWind, StormRattle, WaveHorn, StageComplete, UIClick, MinigameSuccess, MinigameFail, AmbientBase, LootCollect, SteelCollect
src/server/init.server.luau — bootstrap. Init order: PlayerTracking->Economy->Building->Resource->Objective->Role->Enemy->Storm->ScrapSpawn->MapDressing->Debug. All pcall-wrapped.
src/server/RemoteGuard.luau — rate limiter. Register(name,maxCalls,windowSec), Check(name,player)->bool. Auto-cleanup on PlayerRemoving.
src/server/Services/PlayerTrackingService.luau — peak/current player count, legacy buff multipliers
src/server/Services/EconomyService.luau — team scrap pool, storm steel, exponential cost (GROWTH_RATE^count), death penalty (15%, 10s cooldown per player), DeductScrap/DeductStormSteel, GetTotalScrapGathered
src/server/Services/BuildingService.luau — blueprint placement->ghost->final building with rotation support. CancelBlueprint removes unfinished ghosts (owner-validated). Turrets deal TurretDamage via Humanoid:TakeDamage + set AggroTarget ObjectValue on rat for turret aggro. Drills rotate+emit. Overlap validation with rotated CFrame. Enforces build-inside-base-radius server-side via BUILDING.MaxBuildRadiusFromCenter. builtCounts tracks/decrements. BuildingHP attr. GetBuildingsLost counter.
src/server/Services/ResourceService.luau — drill stability degradation (0.35 per tick), wrench repair minigame (server validates), pending repair timeout 10s
src/server/Services/ObjectiveService.luau — Titan core (center map), integrity drain when dismantled. Visuals (base/core/scaffold/stage rings/glow/stage table) now read from VisualManifest. ProximityPrompt deposit. Stage 1-4 costs from Constants.TITAN.Stages. CompleteStage deducts scrap+steel, repairs +25 integrity, updates visuals. Stage 4->startFinalStand (GameState="final_stand", hidden 240s timer). Victory if integrity>0 at timer end. BindableEvent: ConnectGameStateChanged(cb). RequestSessionStats lazy-requires Enemy/Building for stats.
src/server/Services/RoleService.luau — role lock after first selection. Scrapper/Fixer/Enforcer. Sets player attrs: Role, SpeedMult, RepairMult, DamageMult. Tool visuals (wrench/shotgun) now read from VisualManifest. Legacy buff from PlayerTrackingService.
src/server/Services/EnemyService.luau — wave spawning (BaseCount + wave*EnemiesPerWave * difficultyMult * randomMult where randomMult is 0.8-1.5, clamped to min 1 enemy). 30s swarm timer per wave. Rats: HP-based with subtype states (standard/elite/thief), state machine (approaching->dismantling->fleeing), and retreat-safety guards so flee state exits movement+dismantle loops deterministically. Thief rats are uncommon, use fixed speed, dismantle at 70% pressure, fill a one-building bag, then flee; thief death converts carried value into larger RatCache drop bonuses. Retreat path now uses far burrows (~400 studs) with distance-aware flee timeout. Rats default-target Titan; turret aggro redirects via ObjectValue. Path-block logic: if route is obstructed/MoveTo stalls, retarget nearest blocking DismantlableBuilding (wall) and dismantle it, then resume main target priority. Cost*HP scoring for fallback selection. Kill rewards drop physical RatCache items (2 scrap each) with 2-3 base drops and stolen-value bonus drops. RatCache pickups are magnetic (Heartbeat loop, 7-stud range, 40 studs/s arc flight, 1.5-stud auto-collect). HitEnemy: server-authoritative damage, Enforcer-only. PunchEnemy: any role, PunchDamage=5, PunchRange=8. Final Stand: elite rats every 3s. IsSwarmActive() exposed.
src/server/Services/StormService.luau — storm every 450s, 20s duration. Defers if swarm active (lazy requires EnemyService, pcall-wrapped). Tether pads + storm steel visuals now read from VisualManifest. Wind damage uses BuildingHP attr. Steel spawns during storm + magnetic pickup (7-stud range, 35 studs/s arc flight, sparkle trail on pull, 1.5-stud auto-collect). Storm steel persists for 3s after storm end before cleanup. PermanentStorm mode for Final Stand.
src/server/Services/ScrapSpawnService.luau — world resource item renamed to JunkBlock (square block) every 6s, up to 5 per batch, value=5 scrap (Constants.LOOT.JunkBlockValue), raycast-placed. Magnetic pickup: Heartbeat loop (0.05s) pulls piles toward players within MagnetRadius (7 studs) with parabolic arc flight at 40 studs/s, subtle spin/wobble during pull, auto-collects at 1.5 studs. Progressive radius: starts 30 studs near Titan, ramps to 180 over 20 cycles (~2 min). No despawn; spawning throttles by MaxActivePiles (60). Flight speed tunable: change PULL_SPEED constant (40 = studs/s).
src/server/Services/DebugService.luau — studio-only commands: SpawnWave, StartStorm, AddScrap
src/client/init.client.luau — bootstrap. Disables CoreGuiType.Backpack. Init order: BlueprintController->ToolController->VFXController->MainHUD. All pcall-wrapped.
src/client/UI/MainHUD.luau — HUD coordinator. Uses Theme for remaining UI colors and VisualManifest for build swatches/icons. Scrap display with rolling-average rate (+X.X/s) refreshed every 1s ticker, storm steel, wave timer (hidden in Final Stand), role selection, build toolbar, build progress bar (hold-E), right-side tool panel, dismantle bars (throttled, Fixer strobe), threat/storm/tether banners, debug panel, Titan progress panel, settings panel, tutorial hints. Delegates repair minigame to RepairMinigameUI, end screens to EndScreenUI.
src/client/UI/RepairMinigameUI.luau — extracted module. Show(drillPart, rootGui, remotes), Clear(). Self-contained needle-and-zone minigame; minigame colors now pulled from Theme.
src/client/UI/EndScreenUI.luau — extracted module. ShowGameOver, ShowVictory, ShowFinalStandBanner, ClearFinalStandBanner. Session stats builder; overlays/banners use Theme colors.
src/client/UI/Theme.luau — shared UI theme + style helpers. Extended with wave/health/role/banner/slider/tutorial/minigame/final-stand color keys.
src/client/Controllers/BlueprintController.luau — client ghost preview with rotation (R key). Ghost material and valid/invalid colors now read from VisualManifest. Hold-to-build: 3s base (Fixer 0.6x), RenderStepped progress, E release cancels, distance check 14 studs. Enforces build-inside-base-radius client-side via BUILDING.MaxBuildRadiusFromCenter. X key to cancel placed blueprints (fires CancelBlueprint). ConnectBuildProgress(cb) for MainHUD.
src/client/Controllers/ToolController.luau — shotgun (Enforcer-only, server-authoritative damage, 3D positional sound, Humanoid.CameraOffset recoil) + wrench (Fixer-only) + punch (any role, unarmed LMB). Shot trail/muzzle/impact colors now read from VisualManifest. Punch targeting uses long click-ray plus nearest-rat fallback inside PunchRange. Exposes EquipCurrentTool/UnequipCurrentTool/GetCurrentToolName/IsCurrentToolEquipped helpers; keeps auto-equip fallback for backpack-disabled UX.
src/client/Controllers/VFXController.luau — AudioManifest-driven. Major particle/flash/ring/storm-override colors now read from VisualManifest (plus dynamic storm blur/tint/ambient overrides from manifest). Includes loot fountain pool, dismantle sparks+wobble, build flash, enemy death, destroy dust/debris, ambient music shifts, steel pickup ring, overclock glow, rat HP bars, per-drill rate labels, flat base-radius border ring, and camera shake via Humanoid.CameraOffset.
src/client/Controllers/EnvironmentController.luau — runtime environment applier: pulls Lighting/Fog/Atmosphere/Bloom/ColorCorrection/SunRays from VisualManifest at init (default.project.json remains fallback). Also creates permanent burrow marker ring and terrain sculpt pass.
src/server/Services/MapDressingService.luau — map dressing generator (scatter junk props, burrow stain zones, and perimeter junk-wall boundary ring).

=== KEY CONSTANTS (current) ===
BASE_COSTS: Turret=100, Drill=250, Wall=30
COMBAT: ShotgunBaseDamage=20, ShotgunRange=30, ShotgunCooldown=0.27, PunchDamage=5, PunchRange=8, PunchCooldown=0.33, RatBaseHealth=50, RatFleeSpeedMult=1.2, BundleDespawn=30s
BUILDING: TurretRange=45, TurretFireInterval=1.5, TurretDamage=7.5, DrillScrapPerTick=8, DrillTickInterval=2, DefaultHP=100, GridSize=4, BaseBuildTimeSeconds=3, MaxBuildRadiusFromCenter=50
ECONOMY: InitialScrap=200, DeathPenalty=15%, DeathCooldown=10s
TITAN: Stages=[300/0, 600/2, 900/5, 1200/10], IntegrityRepair=25, FinalStand=240s, EliteHP=2x, EliteSpeed=1.3x, EliteInterval=3s
WAVES: Interval=120s, FirstWaveDelay=150s, SwarmDuration=30s, Base=6, PerWave=3, SpawnRadius=60, MinSpawnDistanceFromCenter=50, RetreatBurrowDistance=400, RetreatTimeout=[6..16]s (+1.25s buffer)
THIEF_RAT: SpawnChance=0.15, WalkSpeed=14.4, HealthMult=0.85, DismantleProgressMult=0.7, BuildingBagCapacityMult=1.0, RetreatSpeedMult=1.1
STORM: Interval=450s, Duration=20s, WindDmg=2/s, SteelDrops=5
SCRAP_SPAWNS: MinSpawnRadius=30, MaxSpawnRadius=180, RadiusRampCycles=20, MaxActivePiles=60, Interval=6s, Count=5, MagnetRadius=7, PullSpeed=40
LOOT: JunkBlockValue=5, RatCacheValue=2, RatCacheMinDrops=2, RatCacheMaxDrops=3, RatCacheBonusDivisor=75, RatCacheBonusMax=5
MAINTENANCE: ResourceTick=10s, DrillBaseOutput=30, StabilityDegradationPercent=0.35, StabilityDegradationInterval=2s

=== AUDIO MANIFEST ===
ShotgunFire=12222216, EnemyDeath=12222076, BuildPlace=12222253, BuildDestroy=12222084
RepairHiss=9118823107, RepairClank=12222253, StormWind=9125347736, StormRattle=130797915
WaveHorn=9114243152, StageComplete=12221991, UIClick=12221976
MinigameSuccess=12221984, MinigameFail=12222208, AmbientBase=9043887091, LootCollect=12221976, SteelCollect=12221991

=== GAME STATE FLOW ===
"playing" -> player deposits enough -> "final_stand" (stage 4 complete) -> survive 240s -> "victory" OR integrity=0 -> "defeat"
GameState attr on TitanChassis model. BindableEvent in ObjectiveService signals EnemyService+StormService.
Swarm cycle: wave spawns -> 30s swarm -> retreatAllRats -> SwarmEnded -> interval timer -> next wave. Storm defers until swarm ends.

=== REMOTES ===
Functions: RequestEconomyState, RequestBuildCosts, UseWrench, FinishBlueprint, RequestSessionStats
Events: DebugCommand, PlaceBlueprint, BlueprintPlaced, BlueprintFinished, BuildingDismantled, HitEnemy, PunchEnemy, EnemyKilled, ThreatDetected, ScrapUpdated, StormSteelUpdated, StormStarted, StormEnded, TetherStatus, RoleSelected, WaveStarted, UpdateWaveTimer, GlobalGameOver, GlobalVictory, TitanStageCompleted, FinalStandStarted, RepairMinigameResult, DrillRepaired, SwarmEnded, BuildProgress, CancelBlueprint

=== DEPENDENCY GRAPH (server) ===
init.server -> all services (requires at top, inits sequentially)
ObjectiveService -> Constants, Remotes, TheftComponent, EconomyService
EnemyService -> Constants, Remotes, TheftComponent, EconomyService, BuildingService, ObjectiveService, PlayerTrackingService, RemoteGuard
StormService -> Constants, Remotes, TweenService, RunService, EconomyService, BuildingService, PlayerTrackingService, ObjectiveService, EnemyService (lazy, pcall-wrapped)
BuildingService -> Constants, Remotes, Types, TheftComponent, Utils, EconomyService, RemoteGuard
ResourceService -> Constants, Remotes, EconomyService, PlayerTrackingService, RemoteGuard
RoleService -> Constants, Remotes, Utils, PlayerTrackingService, RemoteGuard
ScrapSpawnService -> Constants, EconomyService, RunService
No circular deps. StormService lazy-requires EnemyService for IsSwarmActive. ObjectiveService lazy-requires EnemyService/BuildingService for stats.

=== DEPENDENCY GRAPH (client) ===
init.client -> BlueprintController, ToolController, VFXController, MainHUD
VFXController -> Constants, AudioManifest, Remotes, MainHUD
ToolController -> Constants, AudioManifest, Remotes, BlueprintController, MainHUD
MainHUD -> Constants, AudioManifest, Remotes, BlueprintController, RepairMinigameUI, EndScreenUI
BlueprintController -> Constants, Remotes, Utils
RepairMinigameUI -> Constants, AudioManifest (standalone)
EndScreenUI -> (standalone, remotes passed as param)

=== PHASE STATUS ===
Phase 1: DONE (12/12) — security, architecture, critical bugs
Phase 2: DONE (12/12) — combat, economy, enemies, core mechanics
Phase 3: DONE (8/8) — win condition, Titan stages, Final Stand, victory/defeat, stats
Phase 4: DONE (10/10) — AudioManifest, 3D shotgun sound, build/destroy sounds+VFX, enemy death particles+sound, UI sounds, ambient music, camera shake fix, loot fountain parallelized
Phase 5: DONE (11/11) — building rotation, MainHUD split, responsive layout, role descriptions, Fixer strobe, settings menu, tutorial hints, distance indicator, throttled dismantle bars
Refinement Phase 1: DONE (13/13) — balance tuning (InitialScrap 200, BaseCount 3, FirstWaveDelay 180s), swarm timer (30s + retreatAllRats), smart retargeting (proportional flee + retargetRat), Cost*HP targeting, storm blur 3 + soft tint + 20s duration, storm/swarm exclusion, tether emergence anim, hold-to-build (3s base, Fixer 0.6x), overclock glow, ka-ching, wave timer hidden in Final Stand, rotate hint fix, backpack UI disabled
Refinement Hotfix: DONE (3/3) — tool auto-equip fallback + visible right-side tool panel, progressive scrap spawn radius (30->180 studs over 20 cycles), blueprint removal (X key + CancelBlueprint remote, owner-validated server-side)
Refinement Iteration 2: DONE (4/4) — rat min spawn distance ring (>=50), visible rat HP bars, persistent scraps with active-pile throttling, tool visibility panel + equip toggle for mobile-safe UX
Refinement Iteration 3: DONE (6/6) — scale tuning (faster scraps 6s/5ct, drill output 8/2s, rat HP 50, more rats 6+3/wave, waves 120s/150s delay), rats default-target Titan with turret aggro redirect (ObjectValue on rat), melee punch for all roles (10dmg, 8 range, 1s CD), magnetic scrap pickup (5-stud pull, 1.5-stud collect via Heartbeat), HP bar replication fix (WaitForChild + task.spawn + studs-based sizing 3x0.3)
Refinement Iteration 4: DONE (9/9) — BUGFIX: EnemyService forward-declare dismantleAndDestroyBuilding (module compile failure silently killed wave loop); BUGFIX: StormService pcall-wrap IsSwarmActive check (cascade protection); scrap magnet arc flight (7-stud range, parabolic Y=sin(ratio*pi)*1.5, 35 studs/s); steel magnet arc flight (7-stud range, 35 studs/s, anchor-on-pull, sparkle trail ParticleEmitter); steel pickup VFX (SteelCollect chime + blue expanding ring); scrap rate HUD (rolling 10s average, +X.X/s); per-drill BillboardGui (+X.X/s green/red, attribute-driven refresh); Titan cost rebalance 1.5x (300/600/900/1200 scrap)
Refinement Iteration 5: DONE (5/5) — BUGFIX: remotes.PunchEnemy missing from Remotes.Get() return tables caused EnemyService.Init failure and blocked wave timer/spawns; scrap HUD rate refresh decoupled from pickups with 1s ticker; scrap magnetic flight now has subtle spin/wobble; drill degradation reduced 30% (1.0 -> 0.7/tick); storm steel cleanup delayed 3s after storm end
Refinement Iteration 6: DONE (3/3) — BUGFIX: punch reliability improved by handling click/touch before processed-input early return in ToolController; drill economy buffed (DrillBaseOutput 15 -> 30) and degradation halved (0.7 -> 0.35/tick); wave volatility added with random enemy multiplier 0.8-1.5 per wave on top of existing scaling (min 1 enemy clamp)
Refinement Iteration 7: DONE (6/6) — punch targeting reworked (long click-ray + nearest-rat fallback within PunchRange); rats now retarget/dismantle blocking walls when path to target stalls; base radius marker rendered client-side; building restricted to inside base radius (client+server checks with MaxBuildRadiusFromCenter=50); rat death rewards converted to physical RatCache drops (2 scrap each, 2-3 base + stolen-value bonus clamped); world square scrap item renamed to JunkBlock (value 5)
Refinement Iteration 8: DONE (4/4) — base radius visual changed from filled/vertical-prone cylinder to flat segmented border ring at ground level; RatCache converted from touch-only pickup to magnetic pickup (7-stud range, 40 studs/s pull, arc flight, 1.5-stud collect); aggressive combat rebalance applied (TurretDamage 15 -> 7.5, ShotgunBaseDamage 40 -> 60, PunchDamage 10 -> 15) while preserving role damage multipliers; lint pass clean on touched files
Refinement Iteration 9: DONE (6/6) — BUGFIX: post-wave retreat now deterministically disengages active rats from dismantle/move loops and forces visible flee behavior; added uncommon Thief rat subtype (fixed speed, lower HP, 70% dismantle pressure) with one-building bag-fill flee logic; thief stolen value now contributes larger RatCache bonus drops; retreat burrows moved farther (~400 studs) and flee timeout made distance-aware; TheftComponent accepts optional progress multiplier for subtype-specific dismantle pressure; lint pass clean on touched files
Visual Polish Phase 1: DONE — Lighting/Atmosphere retune, wasteland skybox, baseline post-processing (Bloom/ColorCorrection/SunRays), fog, permanent burrow markers, and terrain sculpting pass.
Visual Polish Phase 2: DONE — Titan expanded to multi-part scaffold + stage ring visuals, buildings upgraded with compound silhouettes, rat model upgraded (head/tail/eyes and thief bag), and loot silhouettes differentiated.
Visual Polish Phase 3: DONE — Added shared `Theme` module; HUD/tool/titan/repair/end screens now use consistent panel/button styling and palette; build toolbar now includes `ViewportFrame` icon previews.
Visual Polish Phase 4: DONE — Added projectile trail, impact pulse hit feedback, floating damage numbers, stronger wave splash presentation/audio, and scrap combo feedback callouts.
Visual Polish Phase 5: DONE — Added map dressing service with world props, burrow zones, boundary readability wall, plus ambient dust particles for stronger world motion.
Visual Manifest Refactor: DONE — Added shared VisualManifest, moved BUILDING.Colors out of Constants, rewired server/client/UI visual consumers to manifest/theme, enabled runtime lighting application in EnvironmentController, and switched active world look to bright industrial daytime.

=== KNOWN REMAINING ISSUES ===
- No persistence/save system (beyond scope — would need DataStoreService)
- Sound asset IDs in AudioManifest are from Roblox classic library; some may need replacement with custom uploads depending on Roblox audio policy
- Role selection currently locks on first choice — no re-selection UI
- DrillSmoke threshold at <20% stability — GDD says 0%, kept at 20% for better warning
